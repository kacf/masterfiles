#######################################################
#
# Test installation of package from local repo
#
#######################################################

body common control
{
    inputs => {   
               "../../../lib/3.6/packages.cf",
               "../../../lib/3.6/paths.cf",
              };
    # bundlesequence  => { "g", "G", default("$(this.promise_filename)") };
    bundlesequence  => { "init", "test", "check" };
    version => "1.0";
}

#######################################################

bundle agent init
{
    vars:
        "name" string => "test-package";

    packages:
        "$(name)"
        package_policy => "delete";
}

#######################################################

bundle agent test
{

    vars:
    
        "name" string => "test-machine";
        
        "version" string => "1.0-1";
            
    packages:
    
        debian::
	    
            "$(name)"
            package_policy => "add",
            package_select => "==",
            package_version => "$(version)",
            package_architectures => { "i386", "amd64" },
            package_method => dpkg_version("$(g.cwd)/repo");
            
        redhat::
        
            "$(name)"
            package_policy => "add",
            package_select => "==",
            package_version => "$(version)",
            package_architectures => { "i386", "x86_64" },
            package_method => dpkg_version("$(g.cwd)/repo");
   
            
              
}



body classes test_set_class(ok_class,notok_class)
{
    promise_kept => { "$(ok_class)" };
    promise_repaired => { "$(ok_class)" };
    repair_failed => { "$(notok_class)" };
}

#######################################################

bundle agent check
{

    classes:
    
        debian::
            "has_pkg" expression => returnszero("dpkg -l $(test.name) > /dev/null", "useshell");

        redhat::
            "has_pkg" expression => returnszero("/bin/rpm -q $(test.name) > /dev/null", "useshell");
            
        any::
            "has_file" expression => fileexists("/dummy.txt");
            "ok" expression => "pass.!fail.has_pkg.has_file";
  
    reports:
      ok::
        "$(this.promise_filename) $(test.name)=$(test.version)  Pass";
      !ok::
        "$(this.promise_filename) FAIL";
}


